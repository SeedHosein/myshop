{% extends "base.html" %}
{% load static %}
{% load jalali_tags %}
{% load blog_extras %}

{% block title %}
    {% if current_category %}
        {{ current_category.name }} • وبلاگ
    {% else %}
        وبلاگ
    {% endif %}
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/blog_list_styles.css' %}">
{% endblock %}

{% block content %}
<main class="mx-auto px-4 py-8">
    <div class="blog-page-container">
        <!-- Sidebar for Categories -->
        <aside class="blog-sidebar">
            {% if categories %}
            <h3 class="text-xl font-bold mb-6">دسته‌بندی‌ها</h3>
            <div class="filter-group">
                <ul class="category-accordion">
                    <li class="category-item">
                        <a href="{% url 'blog:post_list' %}" class="filter-link{% if not current_category %} active{% endif %}">همه‌ی پست‌ها</a>
                    </li>
                    {% for category in categories %}
                        {% blog_category_children category current_category=current_category %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </aside>

        <!-- Main Content for Blog Posts -->
        <div class="blog-posts-content">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
                {% if current_category %}
                    دسته‌بندی {{ current_category.name }}
                {% else %}
                    آخرین پست‌های وبلاگ
                {% endif %}
            </h2>

            {% if posts %}
            <div class="blog-grid">
                {% for post in posts %}
                <div class="blog-card bg-white border rounded-lg overflow-hidden flex flex-col">
                    {% if post.image %}
                    <a href="{{ post.get_absolute_url }}">
                        <img src="{{ post.image.url }}" class="w-full h-48 object-cover" alt="{{ post.title }} image">
                    </a>
                    {% endif %}
                    <div class="px-4 flex flex-col flex-grow-1">
                        <h3 class="font-semibold text-gray-800 h-2">
                            <a href="{{ post.get_absolute_url }}">{{ post.title }}</a>
                        </h3>
                        <p class="text-gray-600 text-sm my-2 flex-grow-1">
                            {{ post.content|striptags|truncatewords_html:30|safe }}
                        </p>
                        <div class="mt-auto pt-3 border-t border-gray-100">
                            {% if post.author.get_full_name %}
                            <small class="text-muted text-xs block">
                                نویسنده: {{ post.author.get_full_name }}
                            </small>
                            {% endif %}
                            <small class="text-muted text-xs block">
                                منتشر شده در: {{ post.published_at|to_jalali:"%Y/%m/%d" }}
                                {% if post.category %}
                                | دسته: <a href="{{ post.category.get_absolute_url }}" class="hover:text-primary-red">{{ post.category.name }}</a>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
            <nav aria-label="Page navigation" class="pagination mt-12">
                {% if page_obj.has_previous %}
                    <a class="page-item" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="قبلی">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                {% else %}
                    <a class="page-item disabled">&laquo;</a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <a class="page-item active" aria-current="page">{{ num }}</a>
                    {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
                        <a class="page-item" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                    {% elif num == 1 or num == page_obj.paginator.num_pages %}
                        <a class="page-item" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                    {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                        {% if page_obj.number|add:'-3' == num and num != 1 or page_obj.number|add:'3' == num and num != page_obj.paginator.num_pages %}
                        <a class="page-item disabled">...</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a class="page-item" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="بعدی">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                {% else %}
                    <span class="page-item disabled">&raquo;</span>
                {% endif %}
            </nav>
            {% endif %}

            {% else %}
            <div class="bg-white p-8 rounded-lg shadow-sm text-center">
                <p class="text-lg text-gray-700">هیچ پستی برای نمایش یافت نشد.</p>
            </div>
            {% endif %}
        </div>
    </div>
</main>
{% endblock content %}

{% block extra_scripts %}
<script src="{% static 'js/blog_list.js' %}"></script>
{% endblock extra_scripts %}