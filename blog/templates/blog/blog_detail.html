{% extends "base.html" %}
{% load static %}
{% load cache %}
{% load jalali_tags %}
{% load blog_extras %}

{% block title %}{{ post.title }} • وبلاگ{% endblock title %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/blog_detail_styles.css' %}">
{% endblock extra_head %}

{% block content %}
{% cache 3600 blog_post post using="blog" %}
<main class="mx-auto px-4 pt-1 pb-8">
    <!-- Breadcrumbs -->
    <nav class="mb-1 text-sm text-gray-500" aria-label="Breadcrumb">
        <ol class="list-none p-0 inline-flex">
            <li class="flex items-center">
                <a href="{% url 'core:home' %}" class="hover:text-primary-red">خانه</a>
                <i class="fas fa-chevron-left mx-2"></i>
            </li>
            <li class="flex items-center">
                <a href="{% url 'blog:post_list' %}" class="hover:text-primary-red">وبلاگ</a>
                <i class="fas fa-chevron-left mx-2"></i>
            </li>
            {% if post.category %}
                {% blog_category_parents post.category as parents %}
                {% for cat in parents %}
                <li class="flex items-center">
                    <a href="{{ cat.get_absolute_url }}" class="hover:text-primary-red">{{ cat.name }}</a>
                    <i class="fas fa-chevron-left mx-2"></i>
                </li>
                {% endfor %}
                <li class="flex items-center">
                    <a href="{{ post.category.get_absolute_url }}" class="hover:text-primary-red">{{ post.category.name }}</a>
                    <i class="fas fa-chevron-left mx-2"></i>
                </li>
            {% endif %}
            <li class="flex items-center text-gray-700">
                {{ post.title }}
            </li>
        </ol>
    </nav>

    <!-- Blog Post Main Section -->
    <div class="blog-post-main-container bg-white border rounded-lg overflow-hidden shadow-sm p-6 lg:p-8">
        <article>
            <header class="mb-6">
                <h1 class="text-3xl lg:text-4xl font-extrabold text-gray-800 mb-3">{{ post.title }}</h1>
                <div class="text-muted text-sm italic mb-4 flex items-center flex-wrap gap-2">
                    <span>منتشر شده در: {{ post.published_at|to_jalali:"%Y/%m/%d" }}</span>
                    <span>توسط: {{ post.author.get_full_name|default:post.author.username|default:"ناشناس" }}</span>
                    {% if post.category %}
                    <span>| دسته: <a href="{{ post.category.get_absolute_url }}" class="text-primary-red hover:underline">{{ post.category.name }}</a></span>
                    {% endif %}
                    <span class="flex items-center gap-1"><i class="fas fa-eye"></i> {{ hitcount.total_hits }} بازدید </span>
                </div>
                {% if post.get_tags_list %}
                    <div class="flex flex-wrap gap-2 mt-3">
                        {% for tag in post.get_tags_list %}
                            <span class="badge px-3 py-1 rounded-full text-xs">{{ tag }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </header>
            {% if post.image %}
            <figure class="mb-6 rounded-lg overflow-hidden">
                <img class="w-full h-auto object-cover" src="{{ post.image.url }}" alt="{{ post.title }}"/>
            </figure>
            {% endif %}
            <section class="mb-8 ck-content leading-loose text-gray-700">
                {{ post.content|safe }}
            </section>
        </article>
    </div>
{% endcache %}

    <!-- Comments Section (Tabs style) -->
    <div class="post-blog-details-tabs mt-8"> {# Reusing product-details-tabs style for consistency #}
        <div class="tabs-nav-container">
            <div class="tabs-nav" id="tabs-nav-blog"> {# Unique ID for blog tabs #}
                <button class="tab-link active" data-tab="comments-tab">نظرات ({{ comments.count }})</button>
            </div>
        </div>
        <div class="tabs-content">
            <div id="comments-tab" class="tab-panel active">
                <div id="comments" class="comments-section">
                    <h3 class="text-xl font-bold mb-4">دیدگاه خود را اضافه کنید</h3>

                    <!-- Comment form -->
                    {% if request.user.is_authenticated or ALLOW_ANONYMOUS_COMMENTS_BLOG %} {# Assuming site_settings for anonymous comments #}
                    <form method="post" action="{% url 'blog:add_blog_comment' post_slug=post.slug %}" id="comment-form" class="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
                        {% csrf_token %}

                        {% if not request.user.is_authenticated %}
                            <div class="mb-4">
                                <label for="id_name" class="block text-sm font-medium text-gray-700 mb-1">نام</label>
                                {{ comment_form.name }}
                                {% if comment_form.name.errors %}
                                    <p class="text-red-500 text-xs italic mt-1">{{ comment_form.name.errors|first }}</p>
                                {% endif %}
                            </div>
                            <div class="mb-4">
                                <label for="id_email" class="block text-sm font-medium text-gray-700 mb-1">ایمیل (نمایش داده نمی‌شود)</label>
                                {{ comment_form.email }}
                                {% if comment_form.email.errors %}
                                    <p class="text-red-500 text-xs italic mt-1">{{ comment_form.email.errors|first }}</p>
                                {% endif %}
                            </div>
                        {% endif %}

                        <div class="mb-4">
                            <label for="id_comment" class="block text-sm font-medium text-gray-700 mb-1">نظر شما</label>
                            {{ comment_form.comment }}
                            {% if comment_form.comment.errors %}
                                <p class="text-red-500 text-xs italic mt-1">{{ comment_form.comment.errors|first }}</p>
                            {% endif %}
                        </div>
                        <button class="btn-primary" type="submit">ثبت نظر</button>
                    </form>
                    {% else %}
                        <p class="text-gray-700 mb-4">لطفا <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="text-primary-red hover:underline">وارد شوید</a> تا دیدگاه خود را ثبت کنید.</p>
                    {% endif %}

                    <h3 class="text-xl font-bold mb-4">نظرات کاربران ({{ comments.count }})</h3>
                    <div class="comments-list">
                    {% cache 3600 blog_comment post using="blog" %}
                        {% for comment in comments %}
                        <div class="comment-item bg-white border border-gray-100 rounded-lg p-4 shadow-sm flex items-start gap-3 mb-4">
                            <div class="flex-shrink-0">
                                <img class="rounded-full" src="{% static 'images/default_avatar.png' %}" alt="تصویر {{ comment.name|default:"ناشناس" }}" width="40" height="40"/>
                            </div>
                            <div class="flex-grow">
                                <div class="comment-header flex justify-between items-center mb-1">
                                    <span class="font-semibold text-gray-800">{{ comment.name|default:"ناشناس" }}</span>
                                    <span class="text-muted text-xs italic">{{ comment.created_at|to_jalali:"%Y/%m/%d" }}</span>
                                </div>
                                <p class="text-gray-700 text-sm">{{ comment.comment|linebreaksbr }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-600 text-center py-4">هنوز نظری ثبت نشده است. برای ثبت نظر اولین نفر باشید!</p>
                        {% endfor %}
                    {% endcache %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>


{% endblock content %}

{% comment %} {% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tabsNav = document.getElementById('tabs-nav-blog');
        if (tabsNav) {
            tabsNav.addEventListener('click', function(event) {
                const clickedTab = event.target.closest('.tab-link');
                if (!clickedTab) return;

                event.preventDefault();

                // Remove 'active' from all tab links and panels
                tabsNav.querySelectorAll('.tab-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.remove('active');
                });

                // Add 'active' to the clicked tab link and its corresponding panel
                clickedTab.classList.add('active');
                const targetTabId = clickedTab.dataset.tab;
                const targetPanel = document.getElementById(targetTabId);
                if (targetPanel) {
                    targetPanel.classList.add('active');
                }
            });
        }
    });
</script>
{% endblock extra_scripts %} {% endcomment %}
