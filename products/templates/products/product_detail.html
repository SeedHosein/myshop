{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load jalali_tags %}
{% load product_extras %}

{% block title %}{{ product.name }} | {{ SHOP_NAME }}{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/product_detail_styles.css' %}">
{% endblock %}

{% block content %}
<main class="container mx-auto px-4 pt-1 pb-8">
    <!-- Breadcrumbs -->
    <nav class="mb-1 text-sm text-gray-500" aria-label="Breadcrumb">
        <ol class="list-none p-0 inline-flex">
            <li class="flex items-center">
                <a href="{% url 'core:home' %}" class="hover:text-primary-red">خانه</a>
                <i class="fas fa-chevron-left mx-2"></i>
            </li>
            <li class="flex items-center">
                <a href="{% url 'products:product_list' %}" class="hover:text-primary-red">محصولات</a>
                <i class="fas fa-chevron-left mx-2"></i>
            </li>
            {% category_parents product.category as parents %}
            {% for cat in parents %}
            <li class="flex items-center">
                <a href="{{ cat.get_absolute_url }}" class="hover:text-primary-red">{{ cat.name }}</a>
                <i class="fas fa-chevron-left mx-2"></i>
            </li>
            {% endfor %}
            <li class="flex items-center">
                <a href="{{ product.category.get_absolute_url }}" class="hover:text-primary-red">{{ product.category.name }}</a>
            </li>
        </ol>
    </nav>

    <!-- Product Main Section -->
    <div class="product-main-container">
        <!-- Gallery -->
        <div class="product-gallery">
            <div class="main-image-container">
                <img src="{{ product.get_main_image_url|default:'/static/images/placeholder.png' }}" alt="{{ product.name }}" id="main-product-image">
                <iframe id="main-product-video" class="hidden" width="100%" height="100%" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <div class="thumbnail-strip">
                {% if product.get_main_image %}
                <div class="thumbnail-item active" data-type="image" data-src="{{ product.get_main_image_url }}">
                    <img src="{{ product.get_main_image_url }}" alt="Thumbnail">
                </div>
                {% endif %}
                {% for image in product.images.all %}
                    {% if not image.is_main %}
                    <div class="thumbnail-item" data-type="image" data-src="{{ image.image.url }}">
                        <img src="{{ image.image.url }}" alt="{{ image.alt_text }}">
                    </div>
                    {% endif %}
                {% endfor %}
                {% for video in product.videos.all %}
                <div class="thumbnail-item video-thumb" data-type="video" data-src="{{ video.video_url|embed_youtube_url }}">
                    <i class="fas fa-play"></i>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Product Info & Purchase -->
        <div class="product-info">
            <h1 class="text-3xl font-extrabold text-gray-800">{{ product.name }}</h1>
            
            <!-- Average Rating Display -->
            <div class="flex items-center my-4">
                <div class="star-rating-display" data-rating="4.1">
                    <div class="star-rating-display-filled"></div>
                </div>
                <span class="text-gray-600 mr-2">(میانگین ۴.۱ از ۵ | ۱۲۵ دیدگاه)</span>
            </div>

            <p class="text-gray-600 my-4">{{ product.description_short }}</p>

            <!-- Price & Purchase Box -->
            <div class="purchase-box">
                {% if variants %}
                <!-- Product Variants (e.g., Color) -->
                <div class="variant-selection my-6">
                    <h3 class="font-extrabold text-gray-800 mb-3" id="variant-name">{{ variants.0.get_variant_name }}</h3>
                    <div class="variant-options">
                        <div class="variant-option items-center variant-selected" data-variant-name="{{ variants.0.get_variant_name }}" data-variant-sku="{{ variants.0.sku }}" style="--variant-color: #e53935;">
                            <p class="variant-text">{{ variants.0.get_attribute_values_value }}</p>
                        </div>
                        {% for variant in variants|slice:"1:" %}
                        <div class="variant-option items-center" data-variant-name="{{ variant.get_variant_name }}" data-variant-sku="{{ variant.sku }}" style="--variant-color: #e53935;">
                            <p class="variant-text">{{ variant.get_attribute_values_value }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-700 font-semibold">قیمت:</span>
                     {% if product.discounted_price and product.discounted_price < product.price %}
                        <div>
                             <span class="text-gray-500 text-lg text-decoration-line-through">{{ product.price|floatformat:0|intcomma }} تومان</span>
                             <span class="text-primary-red font-bold text-3xl d-block">{{ product.discounted_price|floatformat:0|intcomma }} <span class="text-lg">تومان</span></span>
                        </div>
                     {% else %}
                         <span class="text-primary-red font-bold text-3xl">{{ product.price|floatformat:0|intcomma }} <span class="text-lg">تومان</span></span>
                     {% endif %}
                </div>
                
                {% if product.is_active and product.stock > 0 %}
                    <p class="text-green-600 font-semibold mb-4">موجود در انبار</p>
                    {% is_in_cart product.id request cart_items_active cart_items_saved_for_later as in_cart_quantity %}
                    <div class="add-to-cart-container mt-4 w-full {% if in_cart_quantity.0 %}in-cart{% endif %}"
                         data-product-id="{{ product.id }}" 
                         data-product-stock="{{ product.stock }}"
                         data-add-url="{% url 'cart_and_orders:add_to_cart' %}"
                         {% if request.user.is_authenticated and in_cart_quantity.0 %}
                            data-remove-url="{% url 'cart_and_orders:remove_from_cart' in_cart_quantity.1.item.id %}"
                            data-update-url="{% url 'cart_and_orders:update_cart_item_quantity' in_cart_quantity.1.item.id %}"
                         {% elif in_cart_quantity.0 %}
                            data-remove-url="{% url 'cart_and_orders:remove_from_cart' product.id %}"
                            data-update-url="{% url 'cart_and_orders:update_cart_item_quantity' product.id %}"
                         {% else %}
                             data-remove-url="{% url 'cart_and_orders:remove_from_cart' %}"
                             data-update-url="{% url 'cart_and_orders:update_cart_item_quantity' %}"
                         {% endif %}
                             data-base-remove-url="{% url 'cart_and_orders:remove_from_cart' %}"
                             data-base-update-url="{% url 'cart_and_orders:update_cart_item_quantity' %}">
                        <button class="btn-add-to-cart">افزودن به سبد خرید</button>
                        <div class="quantity-controller">
                            <button class="quantity-btn plus">+</button>
                            <span class="quantity-value">{{ in_cart_quantity.0|default:1 }}</span>
                            <button class="quantity-btn minus">-</button>
                            <button class="trash-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                {% else %}
                    <p class="text-red-600 font-semibold mb-4">ناموجود</p>
                    <button class="btn-primary w-full" disabled>افزودن به سبد خرید</button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Product Details Tabs -->
    <div class="product-details-tabs">
        <div class="tabs-nav-container">
            <div class="tabs-nav" id="tabs-nav">
                <button class="tab-link active" data-tab="review">نقد و بررسی</button>
                <button class="tab-link" data-tab="specs">مشخصات فنی</button>
                <button class="tab-link" data-tab="comments">نظرات کاربران</button>
            </div>
        </div>
        <div class="tabs-content">
            <!-- Review Tab -->
            <div id="review" class="tab-panel active ck-content">
                {{ product.description_full|safe|linebreaksbr }}
            </div>
            <!-- Specs Tab -->
            {% comment %} TODO: Put two values ​​of an attribute in one table row. {% endcomment %}
            <div id="specs" class="tab-panel">
                <table class="specs-table">
                    <tbody>
                        {% for attribute_value in product.attribute_values.all %}
                        <tr>
                            <td>{{ attribute_value.attribute }}</td>
                            <td>{{ attribute_value.value }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Comments Tab -->
            <div id="comments" class="tab-panel">
                <h3 class="text-xl font-bold mb-4">نظرات کاربران</h3>
                {% if reviews %}
                <div class="comments-list">
                    {% for comment in reviews %}
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="font-bold">{{ comment.user.get_short_name }}</span>
                            <div class="star-rating-display" data-rating="{{ comment.rating }}"><div class="star-rating-display-filled"></div></div>
                        </div>
                        <p class="comment-body">{{ comment.comment }}</p>
                        <span class="text-sm text-gray-500">{{ comment.created_at|to_jalali:"%Y/%m/%d" }}</span>
                    </div>
                    {% endfor %}
                </div>
                <div class="add-comment-form">
                    <h3 class="text-xl font-bold my-6">دیدگاه خود را بنویسید</h3>
                {% else %}
                <div class="add-comment-form">
                    <h4 class="text-lg my-6">هنوز برای این محصول نظری ثبت نشده. اولین نفری باشید که نظر میدهد:</h4>
                {% endif %}
                    <form method="post" action="{% url 'reviews:add_review' product.slug %}">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-group">
                            <label class="font-semibold mb-2">امتیاز شما:</label>
                            <div class="star-rating-input">
                                <i class="fas fa-star" data-value="5"></i>
                                <i class="fas fa-star" data-value="4"></i>
                                <i class="fas fa-star selected" data-value="3"></i>
                                <i class="fas fa-star selected" data-value="2"></i>
                                <i class="fas fa-star selected" data-value="1"></i>
                            </div>
                            <input type="hidden" name="{{ form.rating.name }}" id="rating-value" value="3">
                        </div>
                        {% for error in form.rating.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                        <textarea name="{{ form.comment.name }}" class="form-textarea mt-4" rows="4" placeholder="نظر شما..."></textarea>
                        {% for error in form.comment.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                        <button type="submit" class="btn-primary mt-4">ارسال دیدگاه</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock content %}

{% block extra_scripts %}
<script src="{% static 'js/product_detail.js' %}"></script>
{% endblock extra_scripts %}