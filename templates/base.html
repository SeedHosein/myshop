<!DOCTYPE html>
{% load static %}
{% load i18n %}
{% load shop_information_tags %}

<html lang="fa-ir" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock title %} | {{ SHOP_NAME }}</title>
    <link rel="stylesheet" href="{% static 'css/ckeditor5-content.css' %}">
    <link rel="stylesheet" href="{% static 'css/base_styles.css' %}">
    {% block extra_head %}{% endblock extra_head %}
</head>
<body>
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 flex justify-between items-center py-4">
            <a href="{% url 'core:home' %}" class="text-3xl font-extrabold text-primary-red">{{ SHOP_NAME }}</a>
            
            <nav id="main-nav" class="hidden lg:flex items-center space-x-8">
                <a href="{% url 'core:home' %}" class="nav-link">Ø®Ø§Ù†Ù‡</a>
                <a href="{% url 'products:product_list' %}" class="nav-link">Ù…Ø­ØµÙˆÙ„Ø§Øª</a>
                <a href="javascript:void(0);" class="nav-link">ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡</a>
                <a href="{% url 'blog:post_list' %}" class="nav-link">ÙˆØ¨Ù„Ø§Ú¯</a>

                {% get_shop_information_value 'about-us' as about_us_slug %}
                {% if about_us_slug %}
                <a href="{% url 'static_pages:static_page_detail' slug_page_detail=about_us_slug %}" 
                class="nav-link">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a>
                {% endif %}
            </nav>

            <div class="flex items-center space-x-5">
                <div style="padding: 0; margin: 0;">
                    <!-- Interactive Search -->
                    <form id="search-form" method="GET" action="{% url 'products:product_search_page' %}" class="search-container">
                        <input type="search"  id="search-query" name="q" class="search-input"
                            placeholder="Ø¬Ø³ØªØ¬Ùˆ..." value="{{ request.GET.q }}"
                            data-search-url="{% url 'products:product_search_api' %}" required>
                        <button class="search-button" type="submit">
                            <i class="fas fa-search text-xl"></i>
                        </button>
                    </form>
                    <div id="search-results-live" class="search-list-group" style="position: absolute; z-index: 1000; display: none;">
                        <!-- Live search results will be injected here by JavaScript -->
                    </div>
                </div>

                <!-- Profile Section -->
                <div class="relative profile-container">
                    
                    
                    {% if user.is_authenticated %}
                    <div class="profile-icon-wrapper">
                        <i class="fas fa-user text-xl text-gray-600"></i>
                        <div class="profile-dropdown">
                            <div class="p-4 border-b text-center">
                                <p class="font-bold text-gray-800">{{ user.get_full_name }}</p>
                                <p class="text-sm text-gray-500">{{ user.email }}</p>
                            </div>
                            <ul class="py-2">
                                <li><a href="{% url 'accounts:profile' %}" class="dropdown-link justify-center"><i class="fas fa-user-circle ml-2"></i>Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</a></li>
                                {% if user.is_staff %}
                                    <li><a href="{% url 'admin:index' %}" class="dropdown-link justify-center"><i class="fa-solid fa-screwdriver-wrench ml-2"></i>Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†</a></li>
                                    <li><a href="{% url 'chat:support_dashboard' %}" class="dropdown-link justify-center"><i class="fa-solid fa-comment-dots ml-2"></i>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</a></li>
                                {% endif %}
                                <li><form method="post" action="{% url 'accounts:logout' %}" style="display: inline;">{% csrf_token %}<button type="submit" class="dropdown-link text-primary-red justify-center btn-logout"><i class="fas fa-sign-out-alt ml-2"></i>Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</button></form></li>
                            </ul>
                        </div>
                    </div>
                    {% else %}
                    <div class="profile-buttons-wrapper">
                        <a href="{% url 'accounts:login' %}" class="btn-login">ÙˆØ±ÙˆØ¯</a>
                        <a href="{% url 'accounts:register' %}" class="btn-signup">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</a>
                    </div>
                    {% endif %}
                </div>
                
                <a href="{% url 'cart_and_orders:cart_detail' %}" class="relative text-gray-600 hover:text-primary-red transition-colors">
                    <i class="fas fa-shopping-bag text-xl"></i>
                    <span class="absolute -top-2 -right-3 bg-primary-red text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold" id="cart-item-count">{{ request.session.cart.item_count|default:0 }}</span>
                </a>
            </div>
             <!-- Mobile Menu Button -->
            <div class="lg:hidden">
                <button id="mobile-menu-button" class="text-gray-700 text-2xl">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        <!-- Mobile Nav -->
        <nav id="mobile-nav" class="hidden lg:hidden bg-white border-t p-4">
             <a href="{% url 'core:home' %}" class="block py-2 px-4 text-gray-700 hover:bg-gray-100 rounded">Ø®Ø§Ù†Ù‡</a>
                <a href="{% url 'products:product_list' %}" class="block py-2 px-4 text-gray-700 hover:bg-gray-100 rounded">Ù…Ø­ØµÙˆÙ„Ø§Øª</a>
                <a href="javascript:void(0);" class="block py-2 px-4 text-gray-700 hover:bg-gray-100 rounded">ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡</a>
                <a href="{% url 'blog:post_list' %}" class="block py-2 px-4 text-gray-700 hover:bg-gray-100 rounded">ÙˆØ¨Ù„Ø§Ú¯</a>
                {% if about_us_slug %}
                <a href="{% url 'static_pages:static_page_detail' slug_page_detail=about_us_slug %}" class="block py-2 px-4 text-gray-700 hover:bg-gray-100 rounded">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a>
                {% endif %}
        </nav>
    </header>

    <div class="container mt-4">
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <p>{{ message }}</p>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">X</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <h2>
            {% block page_title %}
            {% endblock page_title %}
        </h2>

        {% block content %}
        {% endblock content %}
    </div>

    
    <footer class="bg-gray-800 text-white pt-16 pb-6 mt-20">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10 mb-8">
                <!-- About Us -->
                <div>
                    <h3 class="text-4xl font-bold mb-0 mt-0">{{ SHOP_NAME }}</h3>
                    <ul class="space-y-3">
                        {% if about_us_slug %}
                        <li><a href="{% url 'static_pages:static_page_detail' slug_page_detail=about_us_slug %}" 
                            class="text-gray-400 hover:text-white transition-colors">Ø¯Ø±Ø¨Ø§Ø±Ù‡ {{ SHOP_NAME }}</a></li>
                        {% endif %}
                        {% get_shop_information_value 'contact-us' as contact_us_slug %}
                        {% if contact_us_slug %}
                        <li><a href="{% url 'static_pages:static_page_detail' slug_page_detail=contact_us_slug %}" class="text-gray-400 hover:text-white transition-colors">ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø§</a></li>
                        {% endif %}
                        {% comment %} <li><a href="javascript:void(0);" class="text-gray-400 hover:text-white transition-colors"></a></li> {% endcomment %}
                        {% comment %} <li><a href="javascript:void(0);" class="text-gray-400 hover:text-white transition-colors"></a></li> {% endcomment %}
                    </ul>
                    <div class="flex space-x-4 mt-6">
                        {% get_shop_information_value 'instagram' as instagram_id %}
                        {% if instagram_id %}
                            <a href="https://instagram.com/{{ instagram_id }}" class="text-gray-400 hover:text-white text-xl" target="_blank"><i class="fab fa-instagram"></i></a>
                        {% endif %}
                        {% get_shop_information_value 'telegram-channel' as telegram_channel_id %}
                        {% if telegram_channel_id %}
                            <a href="https://t.me/{{ telegram_channel_id }}" class="text-gray-400 hover:text-white text-xl" target="_blank"><i class="fab fa-telegram"></i></a>
                        {% endif %}
                        {% get_shop_information_value 'x(twitter)' as twitter_id %}
                        {% if twitter_id %}
                            <a href="https://x.com/{{ twitter_id }}" class="text-gray-400 hover:text-white text-xl" target="_blank"><i class="fab fa-twitter"></i></a>
                        {% endif %}
                    </div>
                </div>
                <!-- Quick Links -->
                <div>
                    <h3 class="text-lg font-bold text-white mb-4">Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹</h3>
                    <ul class="space-y-3">
                        <li><a href="{% url 'accounts:profile' %}" class="text-gray-400 hover:text-white transition-colors">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</a></li>
                        <li><a href="javascript:void(0);" class="text-gray-400 hover:text-white transition-colors">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´</a></li>
                        <li><a href="javascript:void(0);" class="text-gray-400 hover:text-white transition-colors">ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§</a></li>
                    </ul>
                </div>
                <!-- Customer Service -->
                <div>
                    <h3 class="text-lg font-bold text-white mb-4">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø®Ø±ÛŒØ¯</h3>
                    <ul class="space-y-3">
                        <li><a href="javascript:void(0);" class="text-gray-400 hover:text-white transition-colors">Ù†Ø­ÙˆÙ‡ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</a></li>
                        <li><a href="javascript:void(0);" class="text-gray-400 hover:text-white transition-colors">Ø±ÙˆÛŒÙ‡ Ø§Ø±Ø³Ø§Ù„ Ø³ÙØ§Ø±Ø´</a></li>
                        <li><a href="javascript:void(0);" class="text-gray-400 hover:text-white transition-colors">Ø´ÛŒÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª</a></li>
                    </ul>
                </div>
                <!-- Newsletter -->
                <div>
                    <h3 class="text-lg font-bold text-white mb-4">Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ø®Ø¨Ø±Ù†Ø§Ù…Ù‡</h3>
                    <p class="text-gray-400 text-sm mb-4">Ø§ÙˆÙ„ÛŒÙ† Ù†ÙØ±ÛŒ Ø¨Ø§Ø´ÛŒØ¯ Ú©Ù‡ Ø§Ø² Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ Ø¨Ø§Ø®Ø¨Ø± Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯.</p>
                    <form class="flex mt-4">
                        <input type="email" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø´Ù…Ø§" class="w-full bg-gray-700 border-gray-600 text-white rounded-r-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-primary-red transition-colors">
                        <button class="bg-primary-red text-white px-4 rounded-l-lg font-semibold hover:bg-red-700">Ø«Ø¨Øª</button>
                    </form>
                </div>
            </div>
            {% if home_page_article_content %}
                <article class="ck-content">
                {{ home_page_article_content|safe }}
            </article>
            {% endif %}
        <div class="border-t border-gray-700 pt-6 text-gray-500 container text-center text-sm">
            <span class="text-muted">ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ {{ SHOP_NAME }} Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª - &copy; {% now "Y" %}</span>
        </div>
    </footer>
    
    {% if not user.is_staff %}
        <!-- Chat Widget -->
        <div class="fixed bottom-6 right-6 z-100 flex flex-col items-end">
            <!-- Chat Window -->
            <div id="chat-popup-container" class="chat-popup-container hidden">
                <div class="chat-popup-content">
                    <div class="chat-popup-header">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-headset"></i></div>
                            <span class="font-bold text-sm">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
                        </div>
                        <button id="chat-close-button" class="chat-close-button">&times;</button>
                    </div>
                    {% if user.is_authenticated and CHAT_SESSION_ID %}
                    <div id="chat-log" class="chat-log">
                        <!-- Initial greeting message -->
                        <div class="system-message">Ø³Ù„Ø§Ù…! Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ú©Ù…Ú©ØªØ§Ù† Ú©Ù†Ù…ØŸ ğŸ‘‹</div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-message-input" class="chat-message-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                        <button id="chat-message-submit" class="chat-message-submit"><i class="fas fa-paper-plane"></i></button>
                    </div>
                    {% else %}
                    <!-- INSERT_YOUR_CODE -->
                    <div id="chat-log" class="chat-log">
                        <div class="system-message">Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.</div>
                    </div>
                    <div class="flex justify-center p-4">
                        <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="bg-primary-red text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                            ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Chat Button -->
            <button id="chat-fab" class="chat-fab-button">
                <i class="fas fa-comment-dots"></i>
            </button>
        </div>
    {% endif %}

    <script>
        // Use a global variable for CHAT_SESSION_ID if available from Django context
        // Ensure it's only set if the user is authenticated and not staff
        window.CHAT_SESSION_ID = "{{ CHAT_SESSION_ID|escapejs }}";
        window.CURRENT_USER_EMAIL = "{{ user.email|escapejs }}";
        window.CURRENT_USER_IS_STAFF = {% if user.is_staff %}true{% else %}false{% endif %};
    </script>
    <script src="{% static 'js/base_scripts.js' %}"></script>
    <script src="{% static 'js/search.js' %}"></script>
    {% block extra_scripts %}{% endblock extra_scripts %}
</body>
</html>
